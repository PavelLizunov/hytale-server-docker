services:
  hytale:
    build: .
    container_name: hytale
    restart: unless-stopped
    stdin_open: true
    tty: true
    volumes:
      - ${HYTALE_DATA_DIR:-/opt/hytale-data}:/data
    ports:
      - "${HYTALE_PORT:-5520}:5520/udp"
    environment:
      JAVA_OPTS: "${JAVA_OPTS:--Xms2G -Xmx6G}"
      HYTALE_BIND: "0.0.0.0:5520"
      BACKUP_ENABLED: "${BACKUP_ENABLED:-true}"
      BACKUP_FREQUENCY: "${BACKUP_FREQUENCY:-30}"

  updater:
    build: .
    container_name: hytale-updater
    profiles: ["manual"]
    volumes:
      - ${HYTALE_DATA_DIR:-/opt/hytale-data}:/data
    environment:
      PATCHLINE: "${PATCHLINE:-release}"
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -euo pipefail
        PATCHLINE="$${PATCHLINE:-release}"
        mkdir -p /data/tmp /data/current
        ZIP=/data/tmp/game.zip
        EXTRACT=/data/tmp/extract
        rm -rf "$$EXTRACT" "$$ZIP"
        mkdir -p "$$EXTRACT"
        echo "[updater] downloading ($$PATCHLINE) ..."
        /usr/local/bin/hytale-downloader -patchline "$$PATCHLINE" -download-path "$$ZIP"
        echo "[updater] extracting ..."
        unzip -o "$$ZIP" -d "$$EXTRACT"
        ASSETS="$$(find "$$EXTRACT" -type f -name "Assets.zip" | head -n1 || true)"
        SERVER_DIR="$$(find "$$EXTRACT" -type d -name "Server" | head -n1 || true)"
        test -n "$$ASSETS"
        test -n "$$SERVER_DIR"
        rm -rf /data/current/Server
        mkdir -p /data/current
        cp -a "$$SERVER_DIR" /data/current/Server
        cp -f "$$ASSETS" /data/current/Assets.zip
        rm -rf /data/tmp
        echo "[updater] done. Server files at /data/current/"

  # One-time auth setup (run on host or in container)
  auth-init:
    build: .
    container_name: hytale-auth
    profiles: ["manual"]
    volumes:
      - ${HYTALE_DATA_DIR:-/opt/hytale-data}:/data
    environment:
      TOKENS_DIR: /data/.tokens
    entrypoint: ["/scripts/auth-init.sh"]
